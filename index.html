<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nuestro Álbum de Boda</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Landing -->
  <div id="landing-section" class="landing-section">
    <div class="landing-overlay"></div>
    <div class="landing-content">
      <h1 class="landing-title">Samuel & Lisbeth</h1>
      <p class="landing-subtitle">Un día inolvidable</p>
      <button id="view-album-btn" class="view-album-btn">Ver Álbum</button>
    </div>
  </div>

  <!-- Main -->
  <div id="main-content" class="main-content hidden">
    <header class="header">
      <div class="header-content">
        <h1 class="header-title">Nuestros Momentos Especiales</h1>
      </div>
    </header>

    <main class="main">
      <section class="section">
        <h2 class="section-title">Momentos</h2>
        <div id="albums-grid" class="albums-grid">
          <div class="loading">Cargando momentos...</div>
        </div>
      </section>

      <section id="gallery-section" class="section hidden">
        <button id="back-btn" class="back-btn">← Volver</button>
        <h2 id="gallery-title" class="section-title"></h2>
        <div id="gallery-grid" class="gallery-grid"></div>
      </section>
    </main>

    <!-- Lightbox -->
    <div id="lightbox" class="lightbox hidden">
      <button class="lightbox-close">×</button>
      <button class="lightbox-prev">‹</button>
      <button class="lightbox-next">›</button>
      <button class="lightbox-download" title="Descargar foto">⬇</button>
      <img class="lightbox-img" src="">
      <div class="lightbox-counter"></div>
    </div>

  </div>

  <!-- FIREBASE + APP -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      onSnapshot,
      collection,
      query,
      orderBy,
      onSnapshot as listenCol
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAzyFSpQSlo5ZrV-OioFxvgyPMsRLvELKQ",
      authDomain: "boda-725be.firebaseapp.com",
      projectId: "boda-725be",
      storageBucket: "boda-725be.firebasestorage.app",
      messagingSenderId: "970840545058",
      appId: "1:970840545058:web:a49837df3e80f0a8cdf77b",
      measurementId: "G-4C066E3VN1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    const landing = document.getElementById("landing-section");
    const viewBtn = document.getElementById("view-album-btn");
    const mainContent = document.getElementById("main-content");
    const albumsGrid = document.getElementById("albums-grid");
    const gallerySection = document.getElementById("gallery-section");
    const galleryGrid = document.getElementById("gallery-grid");
    const galleryTitle = document.getElementById("gallery-title");
    const backBtn = document.getElementById("back-btn");

    // -------- Descargar universal (iPhone + Android + PC) ----------
    async function forceDownload(url, filename) {
      try {
        const res = await fetch(url, { mode: "cors" });
        const blob = await res.blob();

        const blobUrl = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = blobUrl;
        a.download = filename || "foto.jpg";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(blobUrl);
      } catch (err) {
        console.error("ForceDownload error:", err);
        alert("No se pudo descargar la imagen");
      }
    }

    // Lightbox function
    const lightbox = document.getElementById("lightbox");
    const lbImg = lightbox.querySelector(".lightbox-img");

    function openLightbox(url, filename) {
      lbImg.dataset.originalUrl = url;
      lbImg.dataset.filename = filename;
      lbImg.src = url + "?v=" + Date.now();
      lightbox.classList.remove("hidden");
    }

    lightbox.querySelector(".lightbox-download").onclick = () => {
      const cleanUrl = lbImg.dataset.originalUrl;
      const filename = lbImg.dataset.filename || "foto.jpg";
      forceDownload(cleanUrl, filename);
    };

    lightbox.querySelector(".lightbox-close").onclick = () =>
      lightbox.classList.add("hidden");

    // ----- UI -----
    viewBtn.onclick = () => {
      mainContent.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    };

    backBtn.onclick = () => gallerySection.classList.add("hidden");

    // -------- COVER (portada dinámica) ----------
    const settingsDoc = doc(db, "meta", "settings");
    onSnapshot(settingsDoc, (snap) => {
      const data = snap.exists() ? snap.data() : {};
      const url = data.coverUrl || "";
      landing.style.backgroundImage = url
        ? `url("${url}?v=${Date.now()}")`
        : "url('placeholder.svg')";
    });

    // -------- ALBUMS ----------
    const albumsCol = collection(db, "albums");
    listenCol(query(albumsCol, orderBy("createdAt", "desc")), (snap) => {
      albumsGrid.innerHTML = "";
      snap.forEach((d) => {
        const a = d.data();
        const card = document.createElement("div");
        card.className = "album-card";
        const cover = (a.coverUrl || "/placeholder.svg") + "?v=" + Date.now();

        card.innerHTML = `
          <img class="album-card-bg" src="${cover}">
          <div class="album-card-overlay">
            <div class="album-card-title">${a.name}</div>
            <div class="album-card-count">${a.count || 0} fotos</div>
          </div>
        `;

        card.onclick = () => openAlbum(d.id, a.name);
        albumsGrid.appendChild(card);
      });

      if (snap.size === 0) {
        albumsGrid.innerHTML = "<div class='loading'>No hay momentos aún.</div>";
      }
    });

    // -------- FOTOS ----------
    const photosCol = collection(db, "photos");

    function openAlbum(albumId, name) {
      galleryTitle.textContent = name;
      galleryGrid.innerHTML = "<div class='loading'>Cargando fotos...</div>";
      gallerySection.classList.remove("hidden");

      listenCol(
        query(photosCol, orderBy("createdAt", "desc")),
        (snap) => {
          const photos = [];
          snap.forEach((d) => {
            const p = d.data();
            if (p.albumId === albumId) photos.push({ id: d.id, ...p });
          });

          galleryGrid.innerHTML = "";

          photos.forEach((p) => {
            const item = document.createElement("div");
            item.className = "gallery-item";

            const img = document.createElement("img");
            img.className = "gallery-item-img";
            img.src = p.url + "?v=" + Date.now();

            img.onclick = () => openLightbox(p.url, p.filename);

            item.appendChild(img);
            galleryGrid.appendChild(item);
          });
        }
      );
    }
  </script>

  <!-- app.js si lo usas -->
  <script type="module" src="app.js"></script>

</body>
</html>
