<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nuestro Álbum de Boda</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- Landing / Cover -->
  <div id="landing-section" class="landing-section">
    <div class="landing-overlay"></div>
    <div class="landing-content">
      <h1 class="landing-title">Samuel & Lisbeth</h1>
      <p class="landing-subtitle">Un día inolvidable</p>
      <button id="view-album-btn" class="view-album-btn">Ver Álbum</button>
    </div>
  </div>

  <!-- Main content -->
  <div id="main-content" class="main-content hidden">
    <header class="header">
      <div class="header-content">
        <h1 class="header-title">Nuestros Momentos Especiales</h1>
      </div>
    </header>

    <main class="main">
      <section class="section">
        <h2 class="section-title">Momentos</h2>
        <div id="albums-grid" class="albums-grid">
          <div class="loading">Cargando momentos...</div>
        </div>
      </section>

      <section id="gallery-section" class="section hidden">
        <button id="back-btn" class="back-btn">← Volver a Momentos</button>
        <h2 id="gallery-title" class="section-title"></h2>
        <div id="gallery-grid" class="gallery-grid"></div>
      </section>
    </main>

    <div id="lightbox" class="lightbox hidden">
      <button class="lightbox-close">×</button>
      <button class="lightbox-prev">‹</button>
      <button class="lightbox-next">›</button>
      <button class="lightbox-download" title="Descargar foto">⬇</button>
      <img class="lightbox-img" src="/placeholder.svg" alt="">
      <div class="lightbox-counter"></div>
    </div>
  </div>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      onSnapshot,
      collection,
      query,
      orderBy,
      onSnapshot as onSnapshotCol,
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // --- FIREBASE CONFIG (igual a tu admin.html) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAzyFSpQSlo5ZrV-OioFxvgyPMsRLvELKQ",
      authDomain: "boda-725be.firebaseapp.com",
      projectId: "boda-725be",
      storageBucket: "boda-725be.firebasestorage.app",
      messagingSenderId: "970840545058",
      appId: "1:970840545058:web:a49837df3e80f0a8cdf77b",
      measurementId: "G-4C066E3VN1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; // compatible con admin.js

    // UI refs
    const landing = document.getElementById('landing-section');
    const viewBtn = document.getElementById('view-album-btn');
    const mainContent = document.getElementById('main-content');
    const albumsGrid = document.getElementById('albums-grid');
    const gallerySection = document.getElementById('gallery-section');
    const galleryGrid = document.getElementById('gallery-grid');
    const galleryTitle = document.getElementById('gallery-title');
    const backBtn = document.getElementById('back-btn');

    // Helper: set landing background image safely with cache-busting
    function setLandingCover(url) {
      if (!url) {
        landing.style.backgroundImage = 'url("/placeholder.svg?height=1080&width=1920")';
        return;
      }
      // add timestamp to prevent cached versions
      const busted = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
      landing.style.backgroundImage = `url("${busted}")`;
    }

    // SHOW main content
    viewBtn.addEventListener('click', () => {
      mainContent.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    backBtn.addEventListener('click', () => {
      gallerySection.classList.add('hidden');
      document.querySelector('.section').scrollIntoView({ behavior: 'smooth' });
    });

    // --- Real-time listener for settings.coverUrl ---
    const settingsDoc = doc(db, 'meta', 'settings');
    onSnapshot(settingsDoc, snap => {
      const data = snap.exists() ? snap.data() : {};
      setLandingCover(data.coverUrl || '');
    });

    // --- Basic album & photo realtime rendering (keeps public site in sync) ---
    // If your existing app.js already does album/photo rendering, this will be harmless.
    const albumsCol = collection(db, 'albums');
    const photosCol = collection(db, 'photos');

    // listen albums (show thumbnails if present)
    onSnapshotCol(query(albumsCol, orderBy('createdAt', 'desc')), snap => {
      albumsGrid.innerHTML = '';
      snap.forEach(d => {
        const a = d.data();
        const card = document.createElement('div');
        card.className = 'album-card';
        const cover = (a.coverUrl || '/placeholder.svg') + '?v=' + Date.now();
        card.innerHTML = `
          <img class="album-card-bg" src="${cover}" alt="${a.name}" />
          <div class="album-card-overlay">
            <div class="album-card-title">${a.name}</div>
            <div class="album-card-count">${a.count || 0} fotos</div>
          </div>
        `;
        card.onclick = () => openAlbum(d.id, a.name);
        albumsGrid.appendChild(card);
      });
      if (snap.size === 0) albumsGrid.innerHTML = '<div class="loading">No hay momentos todavía.</div>';
    });

    // open album -> render photos
    function openAlbum(albumId, name) {
      galleryTitle.textContent = name;
      galleryGrid.innerHTML = '<div class="loading">Cargando fotos...</div>';
      gallerySection.classList.remove('hidden');

      const q = query(photosCol, orderBy('createdAt', 'desc'));
      // simple filter client-side for albumId
      const unsub = onSnapshotCol(q, snap => {
        galleryGrid.innerHTML = '';
        const photos = [];
        snap.forEach(d => { const p = d.data(); p.id = d.id; if (p.albumId === albumId) photos.push(p); });
        if (photos.length === 0) galleryGrid.innerHTML = '<div class="loading">No hay fotos en este momento.</div>';
        photos.forEach(p => {
          const it = document.createElement('div'); it.className = 'gallery-item';
          const img = document.createElement('img'); img.className = 'gallery-item-img';
          img.src = p.url + '?v=' + Date.now();
          img.alt = p.filename || '';
          it.appendChild(img);
          it.onclick = () => openLightbox(p.url);
          galleryGrid.appendChild(it);
        });
      });

      // when user goes back, unsubscribe to avoid memory leaks
      backBtn.onclick = () => { unsub(); gallerySection.classList.add('hidden'); };
    }

    // Lightbox: open full image
    const lightbox = document.getElementById('lightbox');
    const lbImg = lightbox.querySelector('.lightbox-img');
    function openLightbox(url) {
      lbImg.src = url + '?v=' + Date.now();
      lightbox.classList.remove('hidden');
    }
    lightbox.querySelector('.lightbox-close').onclick = () => lightbox.classList.add('hidden');
    lightbox.querySelector('.lightbox-download').onclick = () => {
      const url = lbImg.src;
      const a = document.createElement('a'); a.href = url; a.download = ''; document.body.appendChild(a); a.click(); a.remove();
    };

    // initial UI: make sure landing has placeholder until settings arrive
    setLandingCover('');

    // Optional: if you have app.js logic, keep loading it AFTER this script to avoid race conditions.
    // (Your existing app.js is already included below, so nothing else needed.)

  </script>

  <!-- your existing app.js (keeps other logic intact) -->
  <script type="module" src="app.js"></script>
</body>
</html>
